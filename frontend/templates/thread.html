{{define "title"}}/{{ .Thread.Board }}/ - Thread No.{{ .Thread.Id }}{{end}}
{{define "content"}}
    <div class="board-header">
        <h1><a href="/{{ .Thread.Board }}">/{{ .Thread.Board }}/</a></h1>
        <hr>
    </div>

    <div class="thread-header">
        <span class="nav-links">[<a href="/{{ .Thread.Board }}/">Return</a>] [<a href="#">Top</a>] [<a href="#bottom">Bottom</a>]</span>
    </div>

    {{template "error-message" .}}

    <div class="posts-container">
        {{ range $index, $message := .Thread.Messages }}
            {{/* Pre-compute conditional values once */}}
            {{$extraClasses := "reply-post"}}
            {{$subject := ""}}
            {{if $message.Op}}
                {{$extraClasses = "op-post"}}
                {{$subject = $.Thread.Title}}
            {{end}}

            {{/* Create a dict that matches MessageView structure - embed all Message fields plus context */}}
            {{template "post" (dict
                "Message" $message
                "User" $.User
                "Board" $message.Board
                "ThreadId" $message.ThreadId
                "Id" $message.Id
                "Text" $message.Text
                "Attachments" $message.Attachments
                "Replies" $message.Replies
                "CreatedAt" $message.CreatedAt
                "Op" $message.Op
                "ExtraClasses" $extraClasses
                "Subject" $subject
                "ShowDeleteButton" $.User.Admin
                "ShowReplyButton" true
            )}}
        {{ end }}
    </div><!-- End posts-container -->
    <br clear="left"> <!-- Clear floats/inline-blocks -->

    <hr class="post-separator"> <!-- Separator before bottom reply form -->

    <!-- Reply Form (Bottom) -->
     <div class="post-form-container" id="reply-form-bottom">
        <form action="/{{ .Thread.Board }}/{{ .Thread.Id }}" method="post" enctype="multipart/form-data">
             <input type="hidden" name="form_action" value="reply">
             <table class="form-table">
                 <tbody>
                     <tr>
                         <td class="form-label"><label for="text-reply-bottom">Comment:</label></td>
                         <td>
                             <textarea id="text-reply-bottom" name="text" cols="48" rows="4" required maxlength="{{.Validation.MessageTextMaxLen}}"></textarea>
                         </td>
                     </tr>
                     <tr>
                         <td class="form-label"><label for="attachments-reply-bottom">File:</label></td>
                         <td>{{template "file-input" dict "InputID" "attachments-reply-bottom" "MaxCount" .Validation.MaxAttachmentsPerMessage "MaxTotalSize" .Validation.MaxTotalAttachmentSize "MaxFileSize" .Validation.MaxAttachmentSizeBytes "AllowedImages" .Validation.AllowedImageMimeTypes "AllowedVideos" .Validation.AllowedVideoMimeTypes}}</td>
                     </tr>
                     <tr>
                         <td class="form-label"></td>
                         <td><button type="submit">Post</button></td>
                     </tr>
                 </tbody>
             </table>
        </form>
    </div>

    <div id="bottom"></div>
    <hr>
    <span class="nav-links">[<a href="/{{ .Thread.Board }}/">Return</a>] [<a href="#">Top</a>] [<a href="#bottom">Bottom</a>]</span>

    {{template "popup-reply-form" .}}
{{ end }}