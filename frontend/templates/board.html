{{define "title"}}/{{ .Board.ShortName }}/ - {{ .Board.Name }}{{end}}
{{ define "content" }}
    <div class="board-header">
        <h1><a href="/{{ .Board.ShortName }}">/{{ .Board.ShortName }}/ - {{ .Board.Name }}</a></h1>
        <hr>
    </div>

    {{template "error-message" .}}

    <!-- New Thread Form -->
    <div class="post-form-container">
        <form action="/{{ .Board.ShortName }}" method="post" id="new-thread-form" enctype="multipart/form-data">
             <input type="hidden" name="form_action" value="new_thread">
             <table class="form-table">
                 <tbody>
                     <tr>
                         <td class="form-label"><label for="title">Subject:</label></td>
                         <td>
                             <input type="text" id="title" name="title" size="40" maxlength="{{.Validation.ThreadTitleMaxLen}}">
                             <button type="submit">Post</button>
                         </td>
                     </tr>
                     <tr>
                         <td class="form-label"><label for="text">Comment:</label></td>
                         <td><textarea id="text" name="text" cols="48" rows="4" maxlength="{{.Validation.MessageTextMaxLen}}"></textarea></td>
                     </tr>
                     <tr>
                         <td class="form-label"><label for="attachments">File:</label></td>
                         <td>{{template "file-input" dict "InputID" "attachments" "MaxCount" .Validation.MaxAttachmentsPerMessage "MaxTotalSize" .Validation.MaxTotalAttachmentSize "MaxFileSize" .Validation.MaxAttachmentSizeBytes "AllowedImages" .Validation.AllowedImageMimeTypes "AllowedVideos" .Validation.AllowedVideoMimeTypes}}</td>
                     </tr>
                 </tbody>
             </table>
        </form>
    </div>

    <hr class="section-separator">

    <div class="threads-container">
        {{ range $threadIndex, $thread := .Board.Threads }}
            {{ if gt $threadIndex 0 }}
                <hr class="thread-separator">
            {{ end }}

            <div class="thread-preview">
                {{ if $thread.Messages }} {{/* Check if Messages slice is not empty */}}
                    {{ $opMessage := index $thread.Messages 0 }}
                    {{/* Context already populated by RenderBoard -> RenderThread */}}
                    {{template "post" (dict
                        "Message" $opMessage
                        "User" $.User
                    )}}

                    {{/* Display Reply Previews (rest of the messages) */}}
                    {{ $previewReplies := slice $thread.Messages 1 }} {{/* Get messages from index 1 onwards */}}
                    {{ range $replyIndex, $reply := $previewReplies }}
                        {{/* Context already populated */}}
                        {{template "post" (dict
                            "Message" $reply
                            "User" $.User
                        )}}
                    {{ end }}

                    {{/* Calculate and Display Omitted Count Info */}}
                    {{ $numShownMessages := len $thread.Messages }}
                    {{/* Omitted = TotalReplies - ShownReplies */}}
                    {{ $omittedReplies := sub $thread.MessageCount $numShownMessages }}

                    {{ if gt $omittedReplies 0 }}
                         <div class="reply-summary">
                            {{ $omittedReplies }} {{if eq $omittedReplies 1}}post{{else}}posts{{end}} omitted.
                         </div>
                    {{ end }}


                {{ else }}
                    {{/* Should ideally not happen if a thread exists */}}
                    <p>Thread {{ $thread.Id }} has no messages.</p>
                {{ end }}
            </div> <!-- End thread-preview -->

        {{ else }}
            <p>No threads on this board yet. Why not create one?</p>
        {{ end }}
    </div> <!-- End threads-container -->
    
    {{ $currentPage := .CurrentPage }}
    <div class="pagination">
        {{ $prevPage := sub $currentPage 1 }}
        {{ $nextPage := add $currentPage 1 }}
        {{ if gt $currentPage 1 }}
        <a href="?page={{ $prevPage }}">&lt;&lt; prev</a>
        {{ end }}
        [
        {{ if eq $currentPage 1 }}
            <span>1</span> /
            <a href="?page=2">2</a> /
            <a href="?page=3">3</a>
        {{ else if gt $currentPage 0 }}
            {{ if gt $currentPage 2 }}
            <a href="?page=1">1</a> /
            <span>...</span> /
            {{ end }}
            <a href="?page={{ $prevPage }}">{{ $prevPage }}</a> /
            <span>{{ $currentPage }}</span> /
            <a href="?page={{ $nextPage }}">{{ $nextPage }}</a>
        {{ end }}
        ]
        <a href="?page={{ $nextPage }}">next &gt;&gt;</a>
    </div>

    <!-- Delete Form -->
    <!-- <form id="delete-form" action="/delete" method="post"> ... </form> -->

    {{template "popup-reply-form" .}}
{{ end }}