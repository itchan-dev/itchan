{{define "title"}}/{{ .Board.ShortName }}/ - {{ .Board.Name }}{{end}}
{{ define "content" }}
    <div class="board-header">
        <h1><a href="{{ .Board.ShortName }}">/{{ .Board.ShortName }}/ - {{ .Board.Name }}</a></h1>
        <hr>
    </div>

    <!-- Display Error Message -->
    {{if .Error}}
    <div class="error-message">{{.Error}}</div>
    {{end}}

    <!-- New Thread Form -->
    <div class="post-form-container">
        <form action="/{{ .Board.ShortName }}" method="post" id="new-thread-form">
             <input type="hidden" name="form_action" value="new_thread">
             <table class="form-table">
                 <tbody>
                    <tr>
                        <td class="form-label"><label for="title">Subject:</label></td>
                        <td>
                            <input type="text" id="title" name="title" size="40">
                            <button type="submit">Post</button>
                        </td>
                    </tr>
                    <tr>
                        <td class="form-label"><label for="text">Comment:</label></td>
                        <td><textarea id="text" name="text" cols="48" rows="4" required></textarea></td>
                    </tr>
                    <!-- File input -->
                 </tbody>
             </table>
        </form>
        {{/* Removed error display from here, moved it above the form */}}
    </div>

    <hr class="section-separator">

    <div class="threads-container">
        {{ range $threadIndex, $thread := .Board.Threads }}
            {{ if gt $threadIndex 0 }}
                <hr class="thread-separator">
            {{ end }}

            <div class="thread-preview">
                {{ if $thread.Messages }} {{/* Check if Messages slice is not empty */}}
                    {{ $opMessage := index $thread.Messages 0 }}
                    <div class="post op-post" id="p{{ $opMessage.Id }}">
                         <div class="post-header">
                            <input type="checkbox" name="delete" value="{{ $opMessage.Id }}">
                            {{if $thread.Title}}<span class="post-subject">{{ $thread.Title }}</span>{{end}}
                            <span class="post-author">Anonymous</span>
                            <span class="post-date">{{ $opMessage.CreatedAt.Format "01/02/06(Mon)15:04:05" }}</span>
                            <span class="post-id">
                                No.<a href="/{{ $thread.Board }}/{{ $thread.Id }}#p{{ $opMessage.Id }}">{{ $opMessage.Id }}</a>
                            </span>
                            {{/* --- START: Thread Delete Button --- */}}
                            {{if $.User.Admin}}
                            <form method="POST" action="/{{ $thread.Board }}/{{ $thread.Id }}/delete" class="delete-form" onsubmit="return confirm('Are you sure you want to delete thread No.{{ $thread.Id }}? This cannot be undone.');">
                                [<button type="submit" class="delete-button">Delete Thread</button>]
                            </form>
                            {{end}}
                            {{/* --- END: Thread Delete Button --- */}}
                            <span class="reply-link">[<a href="/{{ $thread.Board }}/{{ $thread.Id }}">Reply</a>]</span>
                        </div>
                        {{ if $opMessage.Attachments }}
                            <div class="post-attachments">
                                File:
                                {{ range $opMessage.Attachments }}
                                    <a href="{{ . }}" target="_blank">{{ . }}</a>
                                {{ end }}
                            </div>
                        {{ end }}
                        <blockquote class="post-body">
                             {{ $opMessage.Text }}
                        </blockquote>
                    </div><!-- End OP Post -->

                    {{/* Display Reply Previews (rest of the messages) */}}
                    {{ $previewReplies := slice $thread.Messages 1 }} {{/* Get messages from index 1 onwards */}}
                    {{ range $replyIndex, $reply := $previewReplies }}
                         <div class="post reply-post" id="p{{ $reply.Id }}">
                            <div class="post-header">
                                <input type="checkbox" name="delete" value="{{ $reply.Id }}">
                                <span class="post-author">Anonymous</span>
                                <span class="post-date">{{ $reply.CreatedAt.Format "01/02/06(Mon)15:04:05" }}</span>
                                <span class="post-id">
                                    No.<a href="/{{ $thread.Board }}/{{ $thread.Id }}#p{{ $reply.Id }}">{{ $reply.Id }}</a>
                                </span>
                                {{/* No delete button for replies in preview */}}
                            </div>
                            {{ if $reply.Attachments }}
                                <div class="post-attachments">
                                    File:
                                    {{ range $reply.Attachments }}
                                        <a href="{{ . }}" target="_blank">{{ . }}</a>
                                    {{ end }}
                                </div>
                            {{ end }}
                            <blockquote class="post-body">
                                {{ $reply.Text }}
                            </blockquote>
                        </div><!-- End Reply Post Preview -->
                    {{ end }}

                    {{/* Calculate and Display Omitted Count Info */}}
                    {{ $numShownMessages := len $thread.Messages }}
                    {{ $numShownReplies := 0 }}
                    {{ if gt $numShownMessages 1 }}{{/* Only calculate if there's more than just the OP */}}
                        {{ $numShownReplies = sub $numShownMessages 1 }}
                    {{ end }}
                    {{/* Omitted = TotalReplies - ShownReplies */}}
                    {{ $omittedReplies := sub $thread.NumReplies $numShownReplies }}

                    {{ if gt $omittedReplies 0 }}
                         <div class="reply-summary">
                            {{ $omittedReplies }} {{ if eq $omittedReplies 1 }}post{{ else }}posts{{ end }} omitted. Click Reply to view.
                         </div>
                    {{ else if gt $thread.NumReplies 0 }} {{/* If there are replies, but none are omitted (all shown) */}}
                        {{/* Optional: Show a link even if all replies are shown, if desired */}}
                        <!--
                        <div class="reply-summary">
                            Click Reply to view.
                        </div>
                        -->
                    {{ end }}


                {{ else }}
                    {{/* Should ideally not happen if a thread exists */}}
                    <p>Thread {{ $thread.Id }} has no messages.</p>
                {{ end }}
            </div> <!-- End thread-preview -->

        {{ else }}
            <p>No threads on this board yet. Why not create one?</p>
        {{ end }}
    </div> <!-- End threads-container -->
    
    {{ $currentPage := .CurrentPage }}
    <div class="pagination">
        {{ $prevPage := sub $currentPage 1 }}
        {{ $nextPage := add $currentPage 1 }}
        {{ if gt $currentPage 1 }}
        <a href="?page={{ $prevPage }}">&lt&lt prev</a>
        {{ end }}
        [
        {{ if eq $currentPage 1 }}
            <span>1</span> /
            <a href="?page=2">2</a> /
            <a href="?page=3">3</a>
        {{ else if gt $currentPage 0 }}
            {{ if gt $currentPage 2 }}
            <a href="?page=1">1</a> /
            <span>...</span> /
            {{ end }}
            <a href="?page={{ $prevPage }}">{{ $prevPage }}</a> /
            <span>{{ $currentPage }}</span> /
            <a href="?page={{ $nextPage }}">{{ $nextPage }}</a>
        {{ end }}
        ]
        <a href="?page={{ $nextPage }}">next &gt&gt</a>
    </div>

    <!-- Delete Form -->
    <!-- <form id="delete-form" action="/delete" method="post"> ... </form> -->

{{ end }}