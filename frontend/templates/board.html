{{define "title"}}/{{ .Board.ShortName }}/ - {{ .Board.Name }}{{end}}
{{ define "content" }}
    <div class="board-header">
        <h1><a href="{{ .Board.ShortName }}">/{{ .Board.ShortName }}/ - {{ .Board.Name }}</a></h1>
        <hr>
    </div>

    {{template "error-message" .}}

    <!-- New Thread Form -->
    <div class="post-form-container">
        <form action="/{{ .Board.ShortName }}" method="post" id="new-thread-form">
             <input type="hidden" name="form_action" value="new_thread">
             <table class="form-table">
                 <tbody>
                     <tr>
                         <td class="form-label"><label for="title">Subject:</label></td>
                         <td>
                             <input type="text" id="title" name="title" size="40" maxlength="{{.Validation.ThreadTitleMaxLen}}">
                             <button type="submit">Post</button>
                         </td>
                     </tr>
                     <tr>
                         <td class="form-label"><label for="text">Comment:</label></td>
                         <td><textarea id="text" name="text" cols="48" rows="4" required maxlength="{{.Validation.MessageTextMaxLen}}"></textarea></td>
                     </tr>
                 </tbody>
             </table>
        </form>
    </div>

    <hr class="section-separator">

    <div class="threads-container">
        {{ range $threadIndex, $thread := .Board.Threads }}
            {{ if gt $threadIndex 0 }}
                <hr class="thread-separator">
            {{ end }}

            <div class="thread-preview">
                {{ if $thread.Messages }} {{/* Check if Messages slice is not empty */}}
                    {{ $opMessage := index $thread.Messages 0 }}
                    {{template "post" dict 
                        "IsOp" true
                        "Board" $thread.Board
                        "MessageID" $opMessage.Id
                        "ThreadID" $thread.Id
                        "HeaderData" (dict 
                            "MessageID" $opMessage.Id
                            "Subject" $thread.Title
                            "CreatedAt" $opMessage.CreatedAt
                            "Link" (printf "/%s/%d#p%d" $thread.Board $thread.Id $opMessage.Id)
                            "Replies" $opMessage.Replies
                            "ShowDeleteButton" $.User.Admin
                            "DeleteButtonData" (dict 
                                "Action" (printf "/%s/%d/delete" $thread.Board $thread.Id)
                                "ConfirmMessage" (printf "Are you sure you want to delete thread No.%d? This cannot be undone." $thread.Id)
                                "ButtonText" "Delete Thread"
                            )
                            "ShowReplyLink" true
                            "ReplyLink" (printf "/%s/%d" $thread.Board $thread.Id)
                        )
                        "AttachmentData" (dict "Attachments" $opMessage.Attachments)
                        "BodyData" (dict "Text" $opMessage.Text)
                    }}

                    {{/* Display Reply Previews (rest of the messages) */}}
                    {{ $previewReplies := slice $thread.Messages 1 }} {{/* Get messages from index 1 onwards */}}
                    {{ range $replyIndex, $reply := $previewReplies }}
                        {{template "post" dict 
                            "IsOp" false
                            "Board" $thread.Board
                            "MessageID" $reply.Id
                            "ThreadID" $thread.Id
                            "HeaderData" (dict 
                                "MessageID" $reply.Id
                                "CreatedAt" $reply.CreatedAt
                                "Link" (printf "/%s/%d#p%d" $thread.Board $thread.Id $reply.Id)
                                "Replies" $reply.Replies
                                "ShowDeleteButton" false
                            )
                            "AttachmentData" (dict "Attachments" $reply.Attachments)
                            "BodyData" (dict "Text" $reply.Text)
                        }}
                    {{ end }}

                    {{/* Calculate and Display Omitted Count Info */}}
                    {{ $numShownMessages := len $thread.Messages }}
                    {{ $numShownReplies := 0 }}
                    {{ if gt $numShownMessages 1 }}{{/* Only calculate if there's more than just the OP */}}
                        {{ $numShownReplies = sub $numShownMessages 1 }}
                    {{ end }}
                    {{/* Omitted = TotalReplies - ShownReplies */}}
                    {{ $omittedReplies := sub $thread.NumReplies $numShownReplies }}

                    {{ if gt $omittedReplies 0 }}
                         <div class="reply-summary">
                            {{$plural := "posts"}}
                            {{if eq $omittedReplies 1}}
                                {{$plural = "post"}}
                            {{end}}
                            {{ $omittedReplies }} {{ $plural }} omitted. Click Reply to view.
                         </div>
                    {{ end }}


                {{ else }}
                    {{/* Should ideally not happen if a thread exists */}}
                    <p>Thread {{ $thread.Id }} has no messages.</p>
                {{ end }}
            </div> <!-- End thread-preview -->

        {{ else }}
            <p>No threads on this board yet. Why not create one?</p>
        {{ end }}
    </div> <!-- End threads-container -->
    
    {{ $currentPage := .CurrentPage }}
    <div class="pagination">
        {{ $prevPage := sub $currentPage 1 }}
        {{ $nextPage := add $currentPage 1 }}
        {{ if gt $currentPage 1 }}
        <a href="?page={{ $prevPage }}">&lt&lt prev</a>
        {{ end }}
        [
        {{ if eq $currentPage 1 }}
            <span>1</span> /
            <a href="?page=2">2</a> /
            <a href="?page=3">3</a>
        {{ else if gt $currentPage 0 }}
            {{ if gt $currentPage 2 }}
            <a href="?page=1">1</a> /
            <span>...</span> /
            {{ end }}
            <a href="?page={{ $prevPage }}">{{ $prevPage }}</a> /
            <span>{{ $currentPage }}</span> /
            <a href="?page={{ $nextPage }}">{{ $nextPage }}</a>
        {{ end }}
        ]
        <a href="?page={{ $nextPage }}">next &gt&gt</a>
    </div>

    <!-- Delete Form -->
    <!-- <form id="delete-form" action="/delete" method="post"> ... </form> -->

    {{template "popup-reply-form" .}}
    {{template "message-preview-template"}}
{{ end }}