{{/* Error message display */}}
{{define "error-message"}}
{{if .Error}}
<div class="error-message">{{.Error}}</div>
{{end}}
{{end}}

{{/* Success message display */}}
{{define "success-message"}}
{{if .Success}}
<div class="success-message">{{.Success}}</div>
{{end}}
{{end}}

{{/* File input with preview - used in forms */}}
{{/* Expects: InputID (string), InputClass (string, optional), MaxCount (int, optional), MaxTotalSize (int64, optional), MaxFileSize (int64, optional), AllowedImages ([]string, optional), AllowedVideos ([]string, optional) */}}
{{define "file-input"}}
<input type="file" {{if .InputID}}id="{{.InputID}}"{{end}} {{if .InputClass}}class="{{.InputClass}}"{{end}} {{if .MaxCount}}data-max-files="{{.MaxCount}}"{{end}} {{if .MaxTotalSize}}data-max-total-size="{{.MaxTotalSize}}"{{end}} {{if .MaxFileSize}}data-max-file-size="{{.MaxFileSize}}"{{end}} name="attachments" multiple accept="image/*,video/*">
<div class="file-hint">
    Hold Ctrl/Cmd to select multiple files{{if .MaxCount}} (max {{.MaxCount}}){{end}}.
    {{if .MaxFileSize}}Max per file: {{bytesToMB .MaxFileSize}}MB.{{end}}
    {{if .MaxTotalSize}} Max total: {{bytesToMB .MaxTotalSize}}MB.{{end}}
    {{if or .AllowedImages .AllowedVideos}} Allowed types: {{mimeTypeExtensions .AllowedImages}}{{if and .AllowedImages .AllowedVideos}}, {{end}}{{mimeTypeExtensions .AllowedVideos}}.{{end}}
</div>
<div class="file-preview-list"{{if .InputID}} data-for="{{.InputID}}"{{end}}></div>
{{end}}

{{/* Password input field - used in auth forms */}}
{{/* Expects: PasswordMinLen (int), InputID (string, optional, defaults to "password") */}}
{{define "password-input"}}
{{$inputID := "password"}}
{{if .InputID}}
    {{$inputID = .InputID}}
{{end}}
<input type="password" id="{{$inputID}}" name="password" required size="30" minlength="{{.PasswordMinLen}}" maxlength="30" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters">
{{end}}

{{define "popup-reply-form"}}
<template id="popup-reply-template">
    <div class="popup-reply-container post-form-container">
        <button class="popup-close-btn" aria-label="Close">&times;</button>
        <form method="post" enctype="multipart/form-data"> {{/* Action will be set by JS */}}
            <input type="hidden" name="form_action" value="reply">
            <table class="form-table">
                <tbody>
                    <tr>
                        <td>
                            <textarea name="text" cols="48" rows="4" required maxlength="{{.Validation.MessageTextMaxLen}}"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td>{{template "file-input" dict "InputClass" "popup-attachments" "MaxCount" .Validation.MaxAttachmentsPerMessage "MaxTotalSize" .Validation.MaxTotalAttachmentSize "MaxFileSize" .Validation.MaxAttachmentSizeBytes "AllowedImages" .Validation.AllowedImageMimeTypes "AllowedVideos" .Validation.AllowedVideoMimeTypes}}</td>
                    </tr>
                    <tr>
                        <td><button type="submit">Post</button></td>
                    </tr>
                </tbody>
            </table>
        </form>
    </div>
</template>
{{end}}

{{/* ===== POST COMPONENTS ===== */}}

{{/* Post header with all standard elements */}}
{{define "post-header"}}
<div class="post-header">
    <input type="checkbox" name="delete" value="{{.MessageID}}">
    {{if .Subject}}<span class="post-subject">{{.Subject}}</span>{{end}}
    <span class="post-author">Anonymous</span>
    <time class="post-date" datetime="{{.CreatedAt.UTC.Format "2006-01-02T15:04:05Z07:00"}}">{{.CreatedAt.UTC.Format "Mon, 02 Jan 2006 15:04:05"}} GMT</time>
    <span class="post-id"><a href="{{.ThreadLink}}" class="thread-link">No.</a><a href="{{.Link}}" class="post-link">{{.MessageID}}</a></span>
    {{if .ShowReplyButton}}
        <span class="post-reply"><a href="#text-reply-bottom" class="post-reply-link">[reply]</a></span>
    {{end}}
    <span class="post-reply-popup"><a href="{{.Link}}" class="post-reply-popup-link">[popup-reply]</a></span>
    {{if .Replies}}
        {{range .Replies}}
            <span class="reply-link">{{.HTMLLinkFrom}}</span>
        {{end}}
    {{end}}
    {{if .ShowDeleteButton}}
        {{template "delete-button" .DeleteButtonData}}
    {{end}}
</div>
{{end}}

{{/* Post attachments section */}}
{{define "post-attachments"}}
{{if .Attachments}}
<div class="post-attachments">
    {{range .Attachments}}
        {{if .File}}
            {{$mediaUrl := printf "/media/%s" .File.FilePath}}
            {{if hasPrefix .File.MimeType "image/"}}
                {{$thumbnailUrl := $mediaUrl}}
                {{if .File.ThumbnailPath}}
                    {{$thumbnailUrl = printf "/media/%s" .File.ThumbnailPath}}
                {{end}}
                <div class="attachment-item">
                    <a href="{{$mediaUrl}}" target="_blank" class="attachment-link">
                        <img src="{{$thumbnailUrl}}" alt="{{.File.OriginalFilename}}" loading="lazy" class="attachment-thumbnail">
                    </a>
                    <div class="attachment-info">
                        <a href="{{$mediaUrl}}" target="_blank">{{.File.OriginalFilename}}</a>
                        ({{if .File.ImageWidth}}{{.File.ImageWidth}}x{{.File.ImageHeight}}, {{end}}{{.File.FileSizeBytes}} bytes)
                    </div>
                </div>
            {{else if hasPrefix .File.MimeType "video/"}}
                <div class="attachment-item">
                    <video controls class="attachment-thumbnail">
                        <source src="{{$mediaUrl}}" type="{{.File.MimeType}}">
                        Your browser does not support the video tag.
                    </video>
                    <div class="attachment-info">
                        <a href="{{$mediaUrl}}" target="_blank">{{.File.OriginalFilename}}</a>
                        ({{.File.FileSizeBytes}} bytes)
                    </div>
                </div>
            {{else}}
                <div class="attachment-item">
                    <a href="{{$mediaUrl}}" target="_blank">{{.File.OriginalFilename}}</a>
                    ({{.File.FileSizeBytes}} bytes)
                </div>
            {{end}}
        {{end}}
    {{end}}
</div>
{{end}}
{{end}}

{{/* Post body content */}}
{{define "post-body"}}
<blockquote class="post-body">{{.Text}}</blockquote>
{{end}}

{{/* Complete post structure */}}
{{/*
    Renders a single post, used on board and thread pages.
    Expects a dict with the following top-level keys:
    - IsOp: (bool) True if the post is the Original Post of a thread.
    - Board: (string) The short name of the board (e.g., "g").
    - MessageID: (int) The unique ID of the message.
    - ThreadID: (int) The ID of the parent thread.
    - HeaderData: (dict) Data for the "post-header" partial.
    - AttachmentData: (dict) Data for the "post-attachments" partial.
    - BodyData: (dict) Data for the "post-body" partial.
*/}}
{{define "post"}}
<div class="post {{if .IsOp}}op-post{{else}}reply-post{{end}}" data-board="{{.Board}}" data-message-id="{{.MessageID}}" data-thread-id="{{.ThreadID}}" id="p{{.MessageID}}">
    {{template "post-header" .HeaderData}}
    {{template "post-attachments" .AttachmentData}}
    {{template "post-body" .BodyData}}
</div>
{{end}}

{{/* ===== DELETE BUTTONS ===== */}}

{{/* Generic delete button form */}}
{{define "delete-button"}}
<form method="POST" action="{{.Action}}" class="delete-form" onsubmit="return confirm('{{.ConfirmMessage}}');">
    [<button type="submit" class="delete-button">{{.ButtonText}}</button>]
</form>
{{end}}

{{/* ===== MESSAGE PREVIEW TEMPLATE ===== */}}

{{define "message-preview-template"}}
<template id="message-preview-template">
    <div class="message-preview post" data-js="preview-container">
        <div class="post-header">
            <span class="post-author">Anonymous</span>
            <span class="post-date" data-js="post-date"></span>
            <span class="post-id" data-js="post-id">No.<a class="post-link" data-js="post-link"></a></span>
            <span class="post-reply" data-js="post-reply"><a class="post-reply-link" data-js="post-reply-link">Reply</a></span>
            <span class="reply-links" data-js="reply-links"></span>
        </div>
        <div class="post-body" data-js="post-body"></div>
    </div>
</template>
{{end}}
