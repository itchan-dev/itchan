{{/* CSRF token hidden field - include in all state-changing forms */}}
{{define "csrf-field"}}
<input type="hidden" name="csrf_token" value="{{.CSRFToken}}">
{{end}}

{{/* Error message display */}}
{{define "error-message"}}
{{if .Error}}
<div class="error-message">{{.Error}}</div>
{{end}}
{{end}}

{{/* Success message display */}}
{{define "success-message"}}
{{if .Success}}
<div class="success-message">{{.Success}}</div>
{{end}}
{{end}}

{{/* File input with preview - used in forms */}}
{{/* Expects: InputID (string), InputClass (string, optional), MaxCount (int, optional), MaxTotalSize (int64, optional), MaxFileSize (int64, optional), AllowedImages ([]string, optional), AllowedVideos ([]string, optional) */}}
{{define "file-input"}}
<input type="file" {{if .InputID}}id="{{.InputID}}"{{end}} {{if .InputClass}}class="{{.InputClass}}"{{end}} {{if .MaxCount}}data-max-files="{{.MaxCount}}"{{end}} {{if .MaxTotalSize}}data-max-total-size="{{.MaxTotalSize}}"{{end}} {{if .MaxFileSize}}data-max-file-size="{{.MaxFileSize}}"{{end}} name="attachments" multiple accept="{{formatAcceptMimeTypes .AllowedImages .AllowedVideos}}">
<div class="file-hint">
    Hold Ctrl/Cmd to select multiple files{{if .MaxCount}} (max {{.MaxCount}}){{end}}.
    {{if .MaxFileSize}}Max per file: {{bytesToMB .MaxFileSize}}MB.{{end}}
    {{if .MaxTotalSize}} Max total: {{bytesToMB .MaxTotalSize}}MB.{{end}}
    {{if or .AllowedImages .AllowedVideos}} Allowed types: {{if .AllowedImages}}{{mimeTypeExtensions .AllowedImages}}{{end}}{{if and .AllowedImages .AllowedVideos}}, {{end}}{{if .AllowedVideos}}{{mimeTypeExtensions .AllowedVideos}}{{end}}.{{end}}
</div>
<div class="file-preview-list"{{if .InputID}} data-for="{{.InputID}}"{{end}}></div>
{{end}}

{{/* Password input field - used in auth forms */}}
{{/* Expects: PasswordMinLen (int), InputID (string, optional, defaults to "password") */}}
{{define "password-input"}}
{{$inputID := "password"}}
{{if .InputID}}
    {{$inputID = .InputID}}
{{end}}
<input type="password" id="{{$inputID}}" name="password" required size="30" minlength="{{.PasswordMinLen}}" maxlength="30" pattern="(?=.*\d)(?=.*[a-z])(?=.*[A-Z]).{8,}" title="Must contain at least one number and one uppercase and lowercase letter, and at least 8 or more characters">
{{end}}

{{define "popup-reply-form"}}
<div class="popup-reply-container post-form-container" style="display: none;">
    <button class="popup-close-btn" aria-label="Close">&times;</button>
    <form method="post" enctype="multipart/form-data"> {{/* Action will be set by JS */}}
        {{template "csrf-field" .}}
        <input type="hidden" name="form_action" value="reply">
        <table class="form-table">
            <tbody>
                <tr>
                    <td>
                        <textarea name="text" cols="48" rows="4" maxlength="{{.Validation.MessageTextMaxLen}}"></textarea>
                    </td>
                </tr>
                <tr>
                    <td>{{template "file-input" dict "InputClass" "popup-attachments" "MaxCount" .Validation.MaxAttachmentsPerMessage "MaxTotalSize" .Validation.MaxTotalAttachmentSize "MaxFileSize" .Validation.MaxAttachmentSizeBytes "AllowedImages" .Validation.AllowedImageMimeTypes "AllowedVideos" .Validation.AllowedVideoMimeTypes}}</td>
                </tr>
                <tr>
                    <td><button type="submit">Post</button></td>
                </tr>
            </tbody>
        </table>
    </form>
</div>
{{end}}

{{/* ===== POST COMPONENTS ===== */}}

{{/* Post header with all standard elements */}}
{{define "post-header"}}
<div class="post-header">
    <input type="checkbox" name="delete" value="{{.Message.Id}}">
    {{/* Show sticky indicator for OP messages */}}
    {{if and .Message.Op .Message.Context.IsSticky}}<span class="sticky-indicator" title="Sticky thread">[Sticky]</span>{{end}}
    {{if .Message.Context.Subject}}<span class="post-subject">{{.Message.Context.Subject}}</span>{{end}}
    <span class="post-author">{{if and .User .User.Admin}}{{.Message.Author.Email}}{{if .Message.Author.Admin}} <span class="admin-badge">[admin]</span>{{end}}{{else}}Anonymous{{end}}</span>
    <time class="post-date" datetime="{{.Message.CreatedAt.UTC.Format "2006-01-02T15:04:05Z07:00"}}">{{.Message.CreatedAt.UTC.Format "Mon, 02 Jan 2006 15:04:05"}} GMT</time>
    <span class="post-id"><a href="{{printf "/%s/%d" .Message.Board .Message.ThreadId}}" class="thread-link">No.</a><a href="{{printf "/%s/%d#p%d" .Message.Board .Message.ThreadId .Message.Id}}" class="post-link">{{.Message.Id}}</a></span>
    <span class="post-reply"><a href="{{printf "/%s/%d#reply-%d" .Message.Board .Message.ThreadId .Message.Id}}" class="post-reply-link">[reply]</a></span>
    <span class="post-reply-popup"><a href="{{printf "/%s/%d#p%d" .Message.Board .Message.ThreadId .Message.Id}}" class="post-reply-popup-link">[popup-reply]</a></span>
    {{if .Message.Replies}}
        {{range .Message.Replies}}
            <span class="reply-link">{{.HTMLLinkFrom}}</span>
        {{end}}
    {{end}}
    {{if .User}}
        {{if .User.Admin}}
            {{/* Show sticky toggle for OP messages */}}
            {{if .Message.Op}}
                {{template "sticky-toggle-button" dict "Action" (printf "/%s/%d/sticky" $.Message.Board $.Message.ThreadId) "IsSticky" .Message.Context.IsSticky "CSRFToken" $.CSRFToken}}
            {{end}}
            {{template "delete-button" dict "Action" (printf "/%s/%d/%d/delete" $.Message.Board $.Message.ThreadId $.Message.Id) "ConfirmMessage" (printf "Delete message #%d?" $.Message.Id) "ButtonText" "delete" "CSRFToken" $.CSRFToken}}
            {{template "blacklist-button" dict "UserId" .Message.Author.Id "CSRFToken" $.CSRFToken}}
        {{end}}
    {{end}}
</div>
{{end}}

{{/* Post attachments section */}}
{{define "post-attachments"}}
{{if .Message.Attachments}}
<div class="post-attachments">
    {{range .Message.Attachments}}
        {{if .File}}
            {{$mediaUrl := printf "/media/%s" .File.FilePath}}
            {{if .File.IsImage}}
                {{$thumbnailUrl := $mediaUrl}}
                {{if .File.ThumbnailPath}}
                    {{/* Dereference pointer first, then use printf */}}
                    {{$thumb := derefStr .File.ThumbnailPath}}
                    {{$thumbnailUrl = printf "/media/%s" $thumb}}
                {{end}}

                <div class="attachment-item">
                    <a href="{{$mediaUrl}}" target="_blank" class="attachment-link">
                        <img src="{{$thumbnailUrl}}" alt="{{.File.OriginalFilename}}" loading="lazy" class="attachment-thumbnail">
                    </a>
                    <div class="attachment-info">
                        <a href="{{$mediaUrl}}" target="_blank">{{.File.OriginalFilename}}</a>
                        ({{if .File.ImageWidth}}{{.File.ImageWidth}}x{{.File.ImageHeight}}, {{end}}{{.File.SizeBytes}} bytes)
                    </div>
                </div>
            {{else if .File.IsVideo}}
                {{$thumbnailUrl := ""}}
                {{if .File.ThumbnailPath}}
                    {{$thumb := derefStr .File.ThumbnailPath}}
                    {{$thumbnailUrl = printf "/media/%s" $thumb}}
                {{end}}
                <div class="attachment-item">
                    <video controls preload="none" {{if $thumbnailUrl}}poster="{{$thumbnailUrl}}"{{end}} class="attachment-thumbnail">
                        <source src="{{$mediaUrl}}" type="{{.File.MimeType}}">
                        Your browser does not support the video tag.
                    </video>
                    <div class="attachment-info">
                        <a href="{{$mediaUrl}}" target="_blank">{{.File.OriginalFilename}}</a>
                        ({{.File.SizeBytes}} bytes)
                    </div>
                </div>
            {{else}}
                <div class="attachment-item">
                    <a href="{{$mediaUrl}}" target="_blank">{{.File.OriginalFilename}}</a>
                    ({{.File.SizeBytes}} bytes)
                </div>
            {{end}}
        {{end}}
    {{end}}
</div>
{{end}}
{{end}}

{{/* Post body content */}}
{{define "post-body"}}
<blockquote class="post-body">{{.Message.Text}}</blockquote>
{{end}}

{{/* Complete post structure */}}
{{/*
    Renders a single post, used on board and thread pages.
    Expects a MessageView struct that embeds Message with context fields:
    - From Message: Board, Id, ThreadId, Text, Attachments, Replies, CreatedAt
    - Context: ExtraClasses, ShowDeleteButton, ShowReplyButton, Subject
    URLs are built in the template using printf.
*/}}
{{define "post"}}
{{/* Compute final CSS classes including highlighting */}}
{{$classes := .Message.Context.ExtraClasses}}
{{if and .User .Message}}
    {{if eq .Message.Author.Id .User.Id}}
        {{$classes = printf "%s my-message" $classes}}
    {{end}}
{{end}}

<div class="post{{if $classes}} {{$classes}}{{end}}" data-board="{{.Message.Board}}" data-message-id="{{.Message.Id}}" data-thread-id="{{.Message.ThreadId}}" id="p{{.Message.Id}}">
    {{template "post-header" .}}
    {{template "post-attachments" .}}
    {{template "post-body" .}}
</div>
{{end}}

{{/* ===== DELETE BUTTONS ===== */}}

{{/* Generic delete button form */}}
{{define "delete-button"}}
<form method="POST" action="{{.Action}}" class="delete-form" onsubmit="return confirm('{{.ConfirmMessage}}');">
    {{template "csrf-field" .}}
    [<button type="submit" class="delete-button">{{.ButtonText}}</button>]
</form>
{{end}}

{{/* Blacklist button form */}}
{{define "blacklist-button"}}
<form method="POST" action="/blacklist/user" class="blacklist-form" onsubmit="return promptBlacklistReason(event);">
    {{template "csrf-field" .}}
    <input type="hidden" name="userId" value="{{.UserId}}">
    <input type="hidden" name="reason" value="">
    [<button type="submit" class="blacklist-button">blacklist</button>]
</form>
{{end}}

{{/* Sticky toggle button form */}}
{{define "sticky-toggle-button"}}
<form method="POST" action="{{.Action}}" class="sticky-form">
    {{template "csrf-field" .}}
    [<button type="submit" class="sticky-button">{{if .IsSticky}}unsticky{{else}}sticky{{end}}</button>]
</form>
{{end}}

